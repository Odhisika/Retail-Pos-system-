{% extends 'base.html' %}
{% block title %}Create Invoice - {{ site_settings.site_name }}{% endblock %}
{% block page_title %}Create New Invoice{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
    <form method="post" id="invoiceForm">
        {% csrf_token %}

        <!-- Customer Selection -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Customer</label>
                <select name="customer_id" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <option value="">Select Customer</option>
                    {% for customer in customers %}
                    <option value="{{ customer.id }}">{{ customer.name }} ({{ customer.phone }})</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Payment Terms</label>
                <select name="payment_terms"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500">
                    <option value="due_on_receipt">Due on Receipt</option>
                    <option value="net_15">Net 15</option>
                    <option value="net_30" selected>Net 30</option>
                    <option value="net_60">Net 60</option>
                </select>
            </div>
        </div>

        <!-- Items Table -->
        <div class="mb-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Invoice Items</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="itemsTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Action</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="itemsBody">
                        <!-- Items will be added here via JS -->
                    </tbody>
                </table>
            </div>
            <button type="button" onclick="addItem()"
                class="mt-4 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                + Add Item
            </button>
        </div>

        <!-- Totals & Notes -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                <textarea name="notes" rows="4"
                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500"></textarea>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg">
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Subtotal</span>
                    <span class="font-medium" id="subtotalDisplay">{{ site_settings.currency_symbol }}0.00</span>
                </div>
                <div class="flex justify-between mb-2">
                    <span class="text-gray-600">Discount</span>
                    <input type="number" name="discount_amount" value="0" step="0.01" onchange="calculateTotals()"
                        class="w-24 px-2 py-1 border border-gray-300 rounded text-right">
                </div>
                <div class="flex justify-between pt-4 border-t border-gray-200">
                    <span class="text-lg font-bold text-gray-900">Total</span>
                    <span class="text-lg font-bold text-primary-600" id="totalDisplay">
                        {{ site_settings.currency_symbol }}0.00</span>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex justify-end gap-4">
            <a href="{% url 'wholesale:invoice_list' %}"
                class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                Cancel
            </a>
            <button type="submit"
                class="px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors">
                Create Invoice
            </button>
        </div>
    </form>
</div>

<!-- Product Template for JS -->
<template id="itemRowTemplate">
    <tr>
        <td class="px-6 py-4">
            <select name="product_id[]" onchange="updatePrice(this)" required
                class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                <option value="">Select Product</option>
                {% for product in products %}
                <option value="{{ product.id }}" data-price="{{ product.price }}">{{ product.name }}</option>
                {% endfor %}
            </select>
        </td>
        <td class="px-6 py-4">
            <input type="number" name="quantity[]" value="1" min="1" onchange="updateRowTotal(this)" required
                class="w-24 px-3 py-2 border border-gray-300 rounded-lg">
        </td>
        <td class="px-6 py-4">
            <input type="number" name="unit_price[]" step="0.01" onchange="updateRowTotal(this)" required
                class="w-32 px-3 py-2 border border-gray-300 rounded-lg">
        </td>
        <td class="px-6 py-4">
            <span class="row-total font-medium">{{ site_settings.currency_symbol }}0.00</span>
        </td>
        <td class="px-6 py-4">
            <button type="button" onclick="removeItem(this)" class="text-red-600 hover:text-red-800">Remove</button>
        </td>
    </tr>
</template>

<script>
    function addItem() {
        const template = document.getElementById('itemRowTemplate');
        const clone = template.content.cloneNode(true);
        document.getElementById('itemsBody').appendChild(clone);
    }

    function removeItem(btn) {
        btn.closest('tr').remove();
        calculateTotals();
    }

    function updatePrice(select) {
        const option = select.options[select.selectedIndex];
        const price = option.dataset.price || 0;
        const row = select.closest('tr');
        row.querySelector('input[name="unit_price[]"]').value = price;
        updateRowTotal(select);
    }

    function updateRowTotal(input) {
        const row = input.closest('tr');
        const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
        const price = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
        const total = qty * price;
        row.querySelector('.row-total').textContent = '{{ site_settings.currency_symbol }}' + total.toFixed(2);
        calculateTotals();
    }

    function calculateTotals() {
        let subtotal = 0;
        document.querySelectorAll('#itemsBody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('input[name="quantity[]"]').value) || 0;
            const price = parseFloat(row.querySelector('input[name="unit_price[]"]').value) || 0;
            subtotal += qty * price;
        });

        const discount = parseFloat(document.querySelector('input[name="discount_amount"]').value) || 0;
        const total = subtotal - discount;

        document.getElementById('subtotalDisplay').textContent = '{{ site_settings.currency_symbol }}' + subtotal.toFixed(2);
        document.getElementById('totalDisplay').textContent = '{{ site_settings.currency_symbol }}' + total.toFixed(2);
    }

    // Add initial empty row
    addItem();
</script>
{% endblock %}