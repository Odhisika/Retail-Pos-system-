{% extends 'base.html' %}
{% block title %}POS - {{ site_settings.site_name }}{% endblock %}
{% block page_title %}Point of Sale{% endblock %}

{% block content %}
<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<div class="flex gap-6 h-[calc(100vh-180px)]">
  <!-- Main Content Area -->
  <div class="flex-1 flex flex-col overflow-hidden">

    <!-- Search Bar -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
      <div class="relative">
        <input type="text" id="productSearch" placeholder="Search product name or SRN......"
          class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] focus:border-transparent text-sm" />
        <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor"
          viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
        </svg>
      </div>
    </div>

    <!-- Categories Section -->
    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
      <h3 class="text-sm font-semibold text-gray-700 mb-3">Categories</h3>
      <div class="grid grid-cols-4 gap-3" id="categoriesGrid">
        <button onclick="filterByCategory('')"
          class="category-tile bg-gray-50 hover:bg-[#2C3E50] hover:text-white border border-gray-200 rounded-lg p-4 text-center transition-all active-category">
          <div class="text-sm font-medium">All Products</div>
          <div class="text-xs text-gray-500 mt-1">{{ products|length }}</div>
        </button>
        {% for category in categories %}
        <button onclick="filterByCategory('{{ category.id }}')"
          class="category-tile bg-gray-50 hover:bg-[#2C3E50] hover:text-white border border-gray-200 rounded-lg p-4 text-center transition-all"
          data-category-id="{{ category.id }}">
          <div class="text-sm font-medium">{{ category.name }}</div>
          <div class="text-xs text-gray-500 mt-1">{{ category.product_set.count }} items</div>
        </button>
        {% endfor %}
      </div>
    </div>

    <!-- Products Grid -->
    <div class="flex-1 overflow-y-auto bg-white p-4 rounded-lg shadow-sm border border-gray-200">
      <h3 class="text-sm font-semibold text-gray-700 mb-3">Products</h3>
      <div id="productsGrid" class="grid grid-cols-2 gap-4">
        {% for product in products %}
        <div
          class="product-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all category-{{ product.category.id }}"
          data-product-id="{{ product.id }}" data-product-name="{{ product.name }}" data-product-sku="{{ product.sku }}"
          data-product-price="{{ product.sell_price }}" data-product-tax="{{ product.tax_rate }}"
          data-product-stock="{{ product.stock }}">
          <div class="mb-3">
            <h4 class="font-semibold text-gray-900 text-sm mb-1">{{ product.name }}</h4>
            <p class="text-xs text-gray-500">{{ product.sku }}</p>
          </div>
          <div class="flex items-center justify-between mb-3">
            <div class="text-lg font-bold text-gray-900">
              <span>{{ site_settings.currency_symbol }}</span><span>{{ product.sell_price }}</span>
            </div>
            <span class="text-xs text-gray-500">stock: {{ product.stock }}</span>
          </div>
          <button onclick="addToCart(this.parentElement)"
            class="w-full bg-[#2C3E50] text-white py-2 rounded-lg text-sm font-medium hover:bg-[#34495E] transition-colors">
            + Add
          </button>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Right Sidebar - Cart -->
  <div class="w-96 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
    <!-- Cart Header -->
    <div class="p-4 border-b border-gray-200">
      <h3 class="text-lg font-semibold text-gray-900">Cart</h3>
    </div>

    <!-- Cart Items -->
    <div id="cartItems" class="flex-1 overflow-y-auto p-4">
      <div id="emptyCart" class="text-center py-12 text-gray-400">
        <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
          </path>
        </svg>
        <p class="text-sm">Cart is empty</p>
      </div>
    </div>

    <!-- Cart Summary -->
    <div class="border-t border-gray-200 p-4 space-y-3">
      <!-- Coupon Code -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code</label>
        <div class="flex gap-2">
          <input type="text" id="couponCode" placeholder="Enter code"
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] text-sm" />
          <button onclick="applyCoupon()"
            class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
            Apply
          </button>
        </div>
        <div id="couponMessage" class="text-xs mt-1"></div>
      </div>

      <!-- Totals -->
      <div class="space-y-2 pt-3 border-t border-gray-200">
        <div class="flex justify-between text-sm">
          <span class="text-gray-600">Subtotal</span>
          <span id="subtotal" class="font-medium">{{ site_settings.currency_symbol }}0.00</span>
        </div>
        <div id="discountRow" class="flex justify-between text-sm text-green-600 hidden">
          <span>Discount:</span>
          <span id="discountAmount">{{ site_settings.currency_symbol }}0.00</span>
        </div>
        <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
          <span>Total :</span>
          <span id="total">{{ site_settings.currency_symbol }}0.00</span>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="space-y-2 pt-3">
        <button onclick="checkout()"
          class="w-full bg-[#2C3E50] text-white py-3 rounded-lg font-semibold hover:bg-[#34495E] transition-colors">
          Check Out
        </button>
        <button onclick="clearCart()" <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
          <div class="relative">
            <input type="text" id="productSearch" placeholder="Search product name or SRN......"
              class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] focus:border-transparent text-sm" />
            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" fill="none" stroke="currentColor"
              viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
      </div>

      <!-- Categories Section -->
      <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 mb-4">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Categories</h3>
        <div class="grid grid-cols-4 gap-3" id="categoriesGrid">
          <button onclick="filterByCategory('')"
            class="category-tile bg-gray-50 hover:bg-[#2C3E50] hover:text-white border border-gray-200 rounded-lg p-4 text-center transition-all active-category">
            <div class="text-sm font-medium">All Products</div>
            <div class="text-xs text-gray-500 mt-1">{{ products|length }}</div>
          </button>
          {% for category in categories %}
          <button onclick="filterByCategory('{{ category.id }}')"
            class="category-tile bg-gray-50 hover:bg-[#2C3E50] hover:text-white border border-gray-200 rounded-lg p-4 text-center transition-all"
            data-category-id="{{ category.id }}">
            <div class="text-sm font-medium">{{ category.name }}</div>
            <div class="text-xs text-gray-500 mt-1">{{ category.product_set.count }} items</div>
          </button>
          {% endfor %}
        </div>
      </div>

      <!-- Products Grid -->
      <div class="flex-1 overflow-y-auto bg-white p-4 rounded-lg shadow-sm border border-gray-200">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Products</h3>
        <div id="productsGrid" class="grid grid-cols-2 gap-4">
          {% for product in products %}
          <div
            class="product-card bg-white border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all category-{{ product.category.id }}"
            data-product-id="{{ product.id }}" data-product-name="{{ product.name }}"
            data-product-sku="{{ product.sku }}" data-product-price="{{ product.sell_price }}"
            data-product-tax="{{ product.tax_rate }}" data-product-stock="{{ product.stock }}">
            <div class="mb-3">
              <h4 class="font-semibold text-gray-900 text-sm mb-1">{{ product.name }}</h4>
              <p class="text-xs text-gray-500">{{ product.sku }}</p>
            </div>
            <div class="flex items-center justify-between mb-3">
              <div class="text-lg font-bold text-gray-900">
                <span>{{ site_settings.currency_symbol }}</span><span>{{ product.sell_price }}</span>
              </div>
              <span class="text-xs text-gray-500">stock: {{ product.stock }}</span>
            </div>
            <button onclick="addToCart(this.parentElement)"
              class="w-full bg-[#2C3E50] text-white py-2 rounded-lg text-sm font-medium hover:bg-[#34495E] transition-colors">
              + Add
            </button>
          </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- Right Sidebar - Cart -->
    <div class="w-96 bg-white rounded-lg shadow-sm border border-gray-200 flex flex-col">
      <!-- Cart Header -->
      <div class="p-4 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">Cart</h3>
      </div>

      <!-- Cart Items -->
      <div id="cartItems" class="flex-1 overflow-y-auto p-4">
        <div id="emptyCart" class="text-center py-12 text-gray-400">
          <svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
            </path>
          </svg>
          <p class="text-sm">Cart is empty</p>
        </div>
      </div>

      <!-- Cart Summary -->
      <div class="border-t border-gray-200 p-4 space-y-3">
        <!-- Coupon Code -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Coupon Code</label>
          <div class="flex gap-2">
            <input type="text" id="couponCode" placeholder="Enter code"
              class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] text-sm" />
            <button onclick="applyCoupon()"
              class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700">
              Apply
            </button>
          </div>
          <div id="couponMessage" class="text-xs mt-1"></div>
        </div>

        <!-- Totals -->
        <div class="space-y-2 pt-3 border-t border-gray-200">
          <div class="flex justify-between text-sm">
            <span class="text-gray-600">Subtotal</span>
            <span id="subtotal" class="font-medium">{{ site_settings.currency_symbol }}0.00</span>
          </div>
          <div id="discountRow" class="flex justify-between text-sm text-green-600 hidden">
            <span>Discount:</span>
            <span id="discountAmount">{{ site_settings.currency_symbol }}0.00</span>
          </div>
          <div class="flex justify-between text-lg font-bold pt-2 border-t border-gray-200">
            <span>Total :</span>
            <span id="total">{{ site_settings.currency_symbol }}0.00</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="space-y-2 pt-3">
          <button onclick="checkout()"
            class="w-full bg-[#2C3E50] text-white py-3 rounded-lg font-semibold hover:bg-[#34495E] transition-colors">
            Check Out
          </button>
          <button onclick="clearCart()"
            class="w-full text-red-600 py-2 text-sm font-medium hover:bg-red-50 rounded-lg transition-colors">
            Clear Cart
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
      <h3 class="text-2xl font-bold text-gray-900 mb-4">Complete Sale</h3>

      <div class="space-y-4 mb-6">
        <!-- Customer Phone -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Customer Phone Number</label>
          <input type="tel" id="customerPhone" placeholder="0XX XXX XXXX"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] text-lg"
            oninput="lookupCustomer(this.value)" />
          <div id="customerInfo" class="text-sm text-gray-600 mt-1"></div>
        </div>

        <!-- Order Summary -->
        <div class="flex justify-between items-center py-3 border-b">
          <span class="text-gray-600">Total Amount</span>
          <span id="modalTotal" class="text-2xl font-bold text-[#2C3E50]">{{ site_settings.currency_symbol
            }}0.00</span>
        </div>

        <!-- Payment Method -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Payment Method</label>
          <select id="paymentMethod"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50]">
            <option value="cash">Cash</option>
            <option value="card">Card</option>
            <option value="mobile">Mobile Money</option>
          </select>
        </div>

        <!-- Amount Tendered (for cash) -->
        <div id="tenderedSection">
          <label class="block text-sm font-medium text-gray-700 mb-2">Amount Tendered</label>
          <input type="number" id="amountTendered" step="0.01"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#2C3E50] text-lg"
            oninput="calculateChange()" />
        </div>

        <!-- Change -->
        <div class="flex justify-between items-center py-3 bg-gray-50 rounded-lg px-4">
          <span class="text-gray-600 font-medium">Change</span>
          <span id="change" class="text-xl font-bold text-green-600">{{ site_settings.currency_symbol
            }}0.00</span>
        </div>

        <!-- Print Receipt Option -->
        <div class="flex items-center">
          <input type="checkbox" id="printReceipt" checked class="w-4 h-4 text-[#2C3E50] rounded">
          <label for="printReceipt" class="ml-2 text-sm text-gray-700">Print receipt after sale</label>
        </div>
      </div>

      <div class="flex gap-3">
        <button onclick="closeCheckoutModal()"
          class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-50">
          Cancel
        </button>
        <button onclick="confirmSale()"
          class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">
          Complete Sale
        </button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4 p-6">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Confirm Action</h3>
      <p id="confirmationMessage" class="text-gray-600 mb-6">Are you sure you want to proceed?</p>
      <div class="flex gap-3">
        <button onclick="closeConfirmationModal()"
          class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50">
          Cancel
        </button>
        <button id="confirmActionBtn"
          class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700">
          Confirm
        </button>
      </div>
    </div>
  </div>

  <script>
    // Toast notification system
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');

      const bgColors = {
        success: 'bg-green-500',
        error: 'bg-red-500',
        warning: 'bg-yellow-500',
        info: 'bg-blue-500'
      };

      const icons = {
        success: '✓',
        error: '✗',
        warning: '⚠',
        info: 'ℹ'
      };

      toast.className = `${bgColors[type]} text-white px-6 py-3 rounded-lg shadow-lg flex items-center gap-2 transform transition-all duration-300 translate-x-0 opacity-100`;
      toast.innerHTML = `<span class="text-lg font-bold">${icons[type]}</span><span>${message}</span>`;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('opacity-0', 'translate-x-full');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    let cart = [];
    let appliedCoupon = null;
    let pendingAction = null;

    // Save cart to localStorage
    function saveCart() {
      localStorage.setItem('posCart', JSON.stringify(cart));
      if (appliedCoupon) {
        localStorage.setItem('posCoupon', JSON.stringify(appliedCoupon));
      } else {
        localStorage.removeItem('posCoupon');
      }
    }

    // Load cart from localStorage
    function loadCart() {
      const savedCart = localStorage.getItem('posCart');
      const savedCoupon = localStorage.getItem('posCoupon');

      if (savedCart) {
        try {
          cart = JSON.parse(savedCart);
        } catch (e) {
          console.error("Error loading cart", e);
          cart = [];
        }
      }

      if (savedCoupon) {
        try {
          appliedCoupon = JSON.parse(savedCoupon);
          document.getElementById("couponCode").value = appliedCoupon.code;
          const messageEl = document.getElementById("couponMessage");
          messageEl.textContent = "✓ Coupon applied successfully!";
          messageEl.className = "text-xs mt-1 text-green-600";
        } catch (e) {
          appliedCoupon = null;
        }
      }

      renderCart();
      calculateTotal();
    }

    // Add product to cart
    function addToCart(element) {
      const productId = String(element.dataset.productId); // Ensure string
      const productName = element.dataset.productName;
      const productSku = element.dataset.productSku;
      const productPrice = parseFloat(element.dataset.productPrice);
      const productTax = parseFloat(element.dataset.productTax);
      const productStock = parseInt(element.dataset.productStock);

      const existingItem = cart.find((item) => item.id === productId);

      if (existingItem) {
        if (existingItem.quantity < productStock) {
          existingItem.quantity++;
          showToast(`Updated ${productName} quantity to ${existingItem.quantity}`, 'success');
        } else {
          showToast('Insufficient stock!', 'error');
          return;
        }
      } else {
        if (productStock > 0) {
          cart.push({
            id: productId,
            name: productName,
            sku: productSku,
            price: productPrice,
            tax_rate: productTax,
            quantity: 1,
            stock: productStock,
          });
          showToast(`Added ${productName} to cart`, 'success');
        } else {
          showToast('Out of stock!', 'error');
          return;
        }
      }

      saveCart();
      renderCart();
      calculateTotal();
    }

    // Render cart items
    function renderCart() {
      const cartContainer = document.getElementById("cartItems");
      const emptyCart = document.getElementById("emptyCart");

      if (cart.length === 0) {
        emptyCart.classList.remove("hidden");
        cartContainer.innerHTML = '<div id="emptyCart" class="text-center py-12 text-gray-400"><svg class="w-16 h-16 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg><p class="text-sm">Cart is empty</p></div>';
        return;
      }

      emptyCart.classList.add("hidden");

      const currencySymbol = "{{ site_settings.currency_symbol }}";
      cartContainer.innerHTML = cart
        .map(
          (item) => `
        <div class="border border-gray-200 rounded-lg p-3 mb-2 hover:border-[#2C3E50] transition-colors group">
            <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                    <h4 class="font-medium text-sm text-gray-900">${item.name}</h4>
                    <p class="text-xs text-gray-500">${item.sku}</p>
                </div>
                <button onclick="removeFromCart('${item.id}')" class="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <button onclick="updateQuantity('${item.id}', -1)" 
                      class="w-8 h-8 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-gray-100 hover:border-gray-400 text-gray-600 font-bold transition-all active:scale-95">
                      -
                    </button>
                    <span class="w-8 text-center font-semibold text-gray-900">${item.quantity}</span>
                    <button onclick="updateQuantity('${item.id}', 1)" 
                      class="w-8 h-8 border border-gray-300 rounded-lg flex items-center justify-center hover:bg-[#2C3E50] hover:text-white hover:border-[#2C3E50] text-gray-600 font-bold transition-all active:scale-95">
                      +
                    </button>
                </div>
                <div class="font-bold text-gray-900">
                  <span>${currencySymbol}</span><span>${(item.price * item.quantity).toFixed(2)}</span>
                </div>
            </div>
        </div>
    `
        )
        .join("");
    }

    // Update quantity
    function updateQuantity(productId, change) {
      const item = cart.find((i) => i.id === String(productId));
      if (!item) return;

      const newQuantity = item.quantity + change;

      if (newQuantity <= 0) {
        removeFromCart(productId);
        return;
      }

      if (newQuantity > item.stock) {
        showToast(`Only ${item.stock} units available!`, 'warning');
        return;
      }

      item.quantity = newQuantity;
      saveCart();
      renderCart();
      calculateTotal();
    }

    // Remove from cart
    function removeFromCart(productId) {
      const item = cart.find((i) => i.id === String(productId));
      if (!item) return;

      cart = cart.filter((i) => i.id !== String(productId));
      showToast(`Removed ${item.name} from cart`, 'info');

      saveCart();
      renderCart();
      calculateTotal();
    }

    // Confirmation Modal Logic
    function showConfirmationModal(message, action) {
      document.getElementById('confirmationMessage').textContent = message;
      document.getElementById('confirmationModal').classList.remove('hidden');
      pendingAction = action;

      // Focus confirm button
      document.getElementById('confirmActionBtn').focus();
    }

    function closeConfirmationModal() {
      document.getElementById('confirmationModal').classList.add('hidden');
      pendingAction = null;
    }

    document.getElementById('confirmActionBtn').addEventListener('click', function () {
      if (pendingAction) {
        pendingAction();
      }
      closeConfirmationModal();
    });

    // Clear cart
    function clearCart() {
      if (cart.length === 0) {
        showToast('Cart is already empty', 'info');
        return;
      }

      showConfirmationModal("Are you sure you want to remove all items from the cart?", function () {
        const itemCount = cart.length;
        cart = [];
        appliedCoupon = null;
        document.getElementById("couponCode").value = "";
        document.getElementById("couponMessage").textContent = "";
        saveCart();
        renderCart();
        calculateTotal();
        showToast(`Cleared ${itemCount} item(s) from cart`, 'success');
      });
    }

    // Calculate total
    function calculateTotal() {
      let subtotal = 0;
      let taxTotal = 0;

      cart.forEach((item) => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
      });

      // Apply discount (only from coupons)
      let discount = 0;

      if (appliedCoupon) {
        discount = appliedCoupon.discount_amount;
      }

      const total = subtotal - discount;

      const currencySymbol = "{{ site_settings.currency_symbol }}";
      document.getElementById("subtotal").textContent = currencySymbol + subtotal.toFixed(2);
      document.getElementById("discountAmount").textContent = currencySymbol + discount.toFixed(2);
      document.getElementById("total").textContent = currencySymbol + total.toFixed(2);

      // Show/hide discount row based on whether discount exists
      const discountRow = document.getElementById("discountRow");
      if (discount > 0) {
        discountRow.classList.remove("hidden");
      } else {
        discountRow.classList.add("hidden");
      }
    }

    //Initialize on page load
    document.addEventListener('DOMContentLoaded', function () {
      loadCart();
    });

    // Apply coupon
    function applyCoupon() {
      const code = document.getElementById("couponCode").value.trim();
      if (!code) {
        showToast('Please enter a coupon code', 'warning');
        return;
      }

      const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

      fetch("/api/pos/validate_coupon/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify({ code: code, cart_total: subtotal }),
      })
        .then((response) => response.json())
        .then((data) => {
          const messageEl = document.getElementById("couponMessage");
          if (data.valid) {
            appliedCoupon = data;
            showToast(`Coupon applied! Discount: ${data.discount_amount.toFixed(2)}`, 'success');
            messageEl.textContent = "✓ Coupon applied successfully!";
            messageEl.className = "text-xs mt-1 text-green-600";
            saveCart();
            calculateTotal();
          } else {
            messageEl.textContent = "✗ " + data.message;
            messageEl.className = "text-xs mt-1 text-red-600";
          }
        })
        .catch((error) => {
          showToast('Error validating coupon: ' + error, 'error');
        });
    }

    // Filter by category
    function filterByCategory(categoryId) {
      const products = document.querySelectorAll(".product-card");
      const tiles = document.querySelectorAll(".category-tile");

      // Update active tile
      tiles.forEach(tile => {
        if (categoryId === "" && !tile.dataset.categoryId) {
          tile.classList.add("bg-[#2C3E50]", "text-white");
          tile.classList.remove("bg-gray-50");
        } else if (tile.dataset.categoryId === categoryId) {
          tile.classList.add("bg-[#2C3E50]", "text-white");
          tile.classList.remove("bg-gray-50");
        } else {
          tile.classList.remove("bg-[#2C3E50]", "text-white");
          tile.classList.add("bg-gray-50");
        }
      });

      // Filter products
      products.forEach((product) => {
        if (!categoryId || product.classList.contains(`category-${categoryId}`)) {
          product.classList.remove("hidden");
        } else {
          product.classList.add("hidden");
        }
      });
    }

    // Search products
    document.getElementById("productSearch").addEventListener("input", function (e) {
      const searchTerm = e.target.value.toLowerCase();
      const products = document.querySelectorAll(".product-card");

      products.forEach((product) => {
        const name = product.dataset.productName.toLowerCase();
        const sku = product.dataset.productSku.toLowerCase();

        if (name.includes(searchTerm) || sku.includes(searchTerm)) {
          product.classList.remove("hidden");
        } else {
          product.classList.add("hidden");
        }
      });
    });

    // Checkout
    function checkout() {
      if (cart.length === 0) {
        showToast('Cart is empty!', 'warning');
        return;
      }

      const total = parseFloat(document.getElementById("total").textContent.replace("{{ site_settings.currency_symbol }}", ""));
      document.getElementById("modalTotal").textContent = "{{ site_settings.currency_symbol }}" + total.toFixed(2);
      document.getElementById("amountTendered").value = total.toFixed(2);
      calculateChange();

      document.getElementById("checkoutModal").classList.remove("hidden");
      document.getElementById("customerPhone").focus();
    }

    // Close checkout modal
    function closeCheckoutModal() {
      document.getElementById("checkoutModal").classList.add("hidden");
    }

    // Calculate change
    function calculateChange() {
      const total = parseFloat(document.getElementById("modalTotal").textContent.replace("{{ site_settings.currency_symbol }}", ""));
      const tendered = parseFloat(document.getElementById("amountTendered").value) || 0;
      const change = tendered - total;

      document.getElementById("change").textContent = "{{ site_settings.currency_symbol }}" + Math.max(0, change).toFixed(2);
    }

    // Lookup customer
    function lookupCustomer(phone) {
      if (phone.length < 10) {
        document.getElementById("customerInfo").textContent = "";
        return;
      }

      fetch(`/api/customers/lookup/?phone=${phone}`)
        .then((response) => response.json())
        .then((data) => {
          if (data.found) {
            document.getElementById("customerInfo").textContent = `✓ ${data.name} - ${data.email || 'No email'}`;
          } else {
            document.getElementById("customerInfo").textContent = "New customer";
          }
        })
        .catch(() => {
          document.getElementById("customerInfo").textContent = "";
        });
    }

    // Confirm sale
    function confirmSale() {
      const phone = document.getElementById("customerPhone").value.trim();
      const total = parseFloat(document.getElementById("modalTotal").textContent.replace("{{ site_settings.currency_symbol }}", ""));
      const tendered = parseFloat(document.getElementById("amountTendered").value) || 0;
      const paymentMethod = document.getElementById("paymentMethod").value;

      if (!phone) {
        showToast('Please enter customer phone number', 'warning');
        return;
      }

      if (paymentMethod === "cash" && tendered < total) {
        showToast('Amount tendered is less than total!', 'error');
        return;
      }

      const discount = parseFloat(document.getElementById("discountAmount").textContent.replace("{{ site_settings.currency_symbol }}", ""));
      const change = tendered - total;

      const saleData = {
        customer_phone: phone,
        discount: discount,
        coupon_code: appliedCoupon ? appliedCoupon.code : null,
        items: cart.map((item) => ({
          product_id: item.id,
          quantity: item.quantity,
          discount: 0,
        })),
        payments: [
          {
            method: paymentMethod,
            amount: total,
            amount_tendered: tendered,
            change_amount: change,
          },
        ],
      };

      fetch("/api/sales/create_sale/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": "{{ csrf_token }}",
        },
        body: JSON.stringify(saleData),
      })
        .then((response) => response.json())
        .then((data) => {
          if (data.reference) {
            showToast('Sale completed successfully! Reference: ' + data.reference, 'success');

            if (document.getElementById("printReceipt").checked) {
              window.open("/pos/receipt/" + data.reference + "/", "_blank");
            }

            cart = [];
            appliedCoupon = null;
            document.getElementById("couponCode").value = "";
            document.getElementById("couponMessage").textContent = "";
            saveCart();
            renderCart();
            calculateTotal();
            closeCheckoutModal();
          } else {
            showToast('Error creating sale: ' + (data.error || 'Unknown error'), 'error');
          }
        })
        .catch((error) => {
          showToast('Error: ' + error, 'error');
        });
    }

    // Payment method change handler
    document.getElementById("paymentMethod").addEventListener("change", function () {
      const tenderedSection = document.getElementById("tenderedSection");
      if (this.value === "cash") {
        tenderedSection.classList.remove("hidden");
      } else {
        tenderedSection.classList.add("hidden");
      }
    });
  </script>

  {% endblock %}